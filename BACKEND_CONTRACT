# SimpleSpend — Backend Contract (Authoritative) 

This document defines the **authoritative backend data contract** for SimpleSpend.

If implementation disagrees with this document, **the implementation is wrong**.  
This contract exists to make frontend behavior predictable, debuggable, and stable.

---

## Scope & Assumptions

- Backend: **Supabase (Postgres + RLS)**
- Frontend: Static PWA
- Auth: Supabase Auth (email/password)
- LocalStorage: view-model cache only
- **Postgres is the source of truth**

---

## Ownership & Access Model (Locked)

### Budget-Centric
- **All data is scoped by `budget_id`**
- Users do not own rows directly
- Access is granted via budget membership

### Membership Rule
A user may read/write a row **only if**:
- They are a member of that row’s `budget_id`

### Roles (Phase-ready)
- `owner` — full control, manage members
- `editor` — create/edit/delete data
- `viewer` — read-only

---

## Canonical Keys & Formats (Locked)

### Month Key
- `month_key`: `YYYY-MM`
- Exactly one row per (`budget_id`, `month_key`)

### Money
- Stored as **integer cents**
- Examples: `amount_cents`, `income_cents`
- Formatting is UI-only

### Dates
- Stored as Postgres `date`
- ISO format: `YYYY-MM-DD`

---

## Tables

### budgets
- `id` (uuid, PK)
- `name`
- `created_at`

---

### budget_members
- `budget_id` (FK → budgets)
- `user_id`
- `role`

---

## Monthly Subsystem

### months
- `budget_id` (FK)
- `month_key`
- `income_cents`

**Constraints**
- PK: (`budget_id`, `month_key`)
- `month_key` format enforced
- Cascade delete removes month data

---

### monthly_categories
- `budget_id`
- `month_key`
- `category_key`
- `name`
- `budgeted_cents`
- `sort_order`
- `is_extra`

**Extra Category (Locked)**
- Fixed `category_key = 'extra99'`
- `name = 'Extra'`
- `is_extra = true`
- Cannot be deleted or renamed
- Hidden unless it has expenses

**Rules**
- Deleting a category never deletes expenses
- Expenses are reassigned to Extra

---

### monthly_expenses
- `id` (uuid, PK)
- `budget_id`
- `month_key`
- `category_key`
- `vendor`
- `item`
- `amount_cents`
- `expense_date`
- `note`

**Constraints**
- `amount_cents ≠ 0`
- FK to monthly_categories
- FK cascade on month delete

---

## Annual Subsystem

### annual_items
Represents either an **annual budget** or a **sinking fund**.

- `id` (uuid, PK)
- `budget_id`
- `type` (`annual_budget` | `sinking_fund`)
- `year`
- `name`
- `item_key` (slug, NOT NULL)
- `target_cents`
- `initial_cents`
- `created_at`
- `updated_at`

**Rules**
- `annual_budget`:
  - `year` NOT NULL
  - scoped to one year
- `sinking_fund`:
  - `year` MUST be NULL
  - persists all-time
- `item_key`:
  - lowercase slug
  - stable across years
  - generated once
  - never changes

---

### annual_ledger
Ledger of all money movement for annual items.

- `id` (uuid, PK)
- `budget_id`
- `annual_item_id`
- `entry_type` (`expense` | `contribution`)
- `amount_cents`
- `entry_date`
- `vendor`
- `item`
- `note`
- `created_at`
- `updated_at`

**Ledger Guards (DB-enforced)**
- `amount_cents ≠ 0`
- `expense`:
  - vendor NOT NULL
  - item NOT NULL
- `contribution`:
  - vendor NULL
  - item NULL

Ledger rows:
- are append-style
- can be edited
- can be deleted
- are always recomputed into totals

---

## Annual Semantics (Locked)

### Annual Budgets
- `initial_cents` = funded amount (budgeted up front)
- `target_cents` = display-only note
- Contributions add money
- Expenses subtract money

**Derived (never stored)**
- Total Available = `initial + contributions`
- Left = `total - spent`

### Rollover Rule
- When a year is first encountered:
  - Annual budgets are cloned from prior year
  - Only the **budgeted/target amount** is copied
  - Happens once per year
  - Never re-runs

---

### Sinking Funds
- `initial_cents` = starting balance
- `target_cents` = goal (ring only)
- Balance = `initial + contributions - spent`
- No year scoping
- Never rolled over

---

## Derived Values (Never Stored)

### Monthly
- Planned Remaining = `income − sum(budgeted)`
- Left to Spend = `income − sum(spent)`

### Annual
- Totals, balances, progress rings

All derived values are computed at read time.

---

## Deletion Rules (Locked)

### Delete Month (Allowed)
Deleting a month must remove:
- `months`
- `monthly_categories` (including Extra)
- `monthly_expenses`

Annual data is never affected by month deletion.

---

## Error Philosophy

- Database constraints enforce correctness
- Frontend validates early for UX
- Errors are surfaced immediately
- No silent correction or fallback

---

## Final Notes

This backend contract exists to:
- prevent data drift
- enforce financial correctness
- allow fearless frontend iteration

Changes to this contract should be rare and deliberate.

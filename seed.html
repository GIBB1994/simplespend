<!doctype html>
<html>
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SimpleSpend Seed</title>
<style>
  body{font-family:system-ui;padding:16px;max-width:900px;margin:0 auto}
  input,button{font-size:16px;padding:10px;margin:6px 0;width:100%;box-sizing:border-box}
  pre{background:#f4f4f4;padding:12px;overflow:auto}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{border:1px solid #ddd;padding:12px;border-radius:10px;margin:12px 0}
</style>
</head>
<body>
<h1>Seed + RLS Test</h1>

<script src="./js/config.js"></script>

<div class="card">
  <h2>Sign In</h2>
  <div class="row">
    <div><input id="email" placeholder="email"/></div>
    <div><input id="password" type="password" placeholder="password"/></div>
  </div>
  <button id="signIn">Sign In</button>
  <button id="signOut">Sign Out</button>
  <pre id="authOut">Not signed in</pre>
</div>

<div class="card">
  <h2>Seed</h2>
  <button id="seed">Run Seed</button>
  <pre id="seedOut"></pre>
</div>

<div class="card">
  <h2>Tests</h2>
  <button id="listBudgets">List Budgets</button>
  <button id="checkExtra">Check extra99 exists</button>
  <button id="catDelete">Create+Delete category â†’ move expense to extra99</button>
  <button id="delMonth">Delete month 2026-01</button>
  <pre id="testOut"></pre>
</div>

<script type="module">
  import { getSupabase } from "./js/supabaseClient.js";
  const supabase = getSupabase();
  const authOut = document.getElementById("authOut");
  const seedOut = document.getElementById("seedOut");
  const testOut = document.getElementById("testOut");
  const log = (el, x) => el.textContent = typeof x === "string" ? x : JSON.stringify(x,null,2);

  let budgetId = null;

  async function refreshAuth(){
    const { data } = await supabase.auth.getSession();
    log(authOut, data?.session ? { email: data.session.user.email, id: data.session.user.id } : "Not signed in");
  }

  document.getElementById("signIn").onclick = async () => {
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return log(authOut, error);
    await refreshAuth();
  };

  document.getElementById("signOut").onclick = async () => {
    await supabase.auth.signOut();
    await refreshAuth();
  };

  document.getElementById("seed").onclick = async () => {
    seedOut.textContent = "Running...";
    const { data: sess } = await supabase.auth.getSession();
    const user = sess.session?.user;
    if (!user) return log(seedOut, "Sign in first.");

    const { data: b, error: bErr } = await supabase
      .from("budgets")
      .insert({ name: "My First Budget", created_by: user.id })
      .select("id")
      .single();
    if (bErr) return log(seedOut, bErr);
    budgetId = b.id;

    const { error: mErr } = await supabase
      .from("budget_members")
      .insert({ budget_id: budgetId, user_id: user.id, role: "owner" });
    if (mErr) return log(seedOut, mErr);

    const { error: moErr } = await supabase
      .from("months")
      .insert({ budget_id: budgetId, month_key: "2026-01", income_cents: 800000 });
    if (moErr) return log(seedOut, moErr);

    const { error: cErr } = await supabase
      .from("monthly_categories")
      .insert({ budget_id: budgetId, month_key: "2026-01", category_key: "groceries", name: "Groceries", budgeted_cents: 60000, sort_order: 10, is_extra: false });
    if (cErr) return log(seedOut, cErr);

    const { error: eErr } = await supabase
      .from("monthly_expenses")
      .insert({ budget_id: budgetId, month_key: "2026-01", category_key: "groceries", vendor: "Walmart", item: "Food", amount_cents: 12345, expense_date: "2026-01-05", note: "seed" });
    if (eErr) return log(seedOut, eErr);

    log(seedOut, { ok: true, budgetId });
  };

  document.getElementById("listBudgets").onclick = async () => {
    const { data, error } = await supabase.from("budgets").select("id,name,created_at").order("created_at",{ascending:false});
    log(testOut, error || data);
  };

  document.getElementById("checkExtra").onclick = async () => {
    if (!budgetId) return log(testOut, "Run seed first.");
    const { data, error } = await supabase
      .from("monthly_categories")
      .select("category_key,name,is_extra")
      .eq("budget_id", budgetId)
      .eq("month_key", "2026-01");
    if (error) return log(testOut, error);
    const hasExtra = data.some(r => r.category_key === "extra99" && r.name === "Extra" && r.is_extra === true);
    log(testOut, { hasExtra, rows: data });
  };

  document.getElementById("catDelete").onclick = async () => {
    if (!budgetId) return log(testOut, "Run seed first.");
    const catKey = "tmp_" + Math.random().toString(16).slice(2,8);

    let r = await supabase.from("monthly_categories").insert({
      budget_id: budgetId, month_key: "2026-01", category_key: catKey, name: "Temp", budgeted_cents: 1000, sort_order: 20, is_extra: false
    });
    if (r.error) return log(testOut, r.error);

    const ins = await supabase.from("monthly_expenses").insert({
      budget_id: budgetId, month_key: "2026-01", category_key: catKey,
      vendor: "Test", item: "Test", amount_cents: 500, expense_date: "2026-01-06"
    }).select("id").single();
    if (ins.error) return log(testOut, ins.error);

    const del = await supabase.from("monthly_categories").delete()
      .eq("budget_id", budgetId).eq("month_key","2026-01").eq("category_key", catKey);
    if (del.error) return log(testOut, del.error);

    const read = await supabase.from("monthly_expenses").select("id,category_key").eq("id", ins.data.id).single();
    if (read.error) return log(testOut, read.error);

    log(testOut, { movedToExtra: read.data.category_key === "extra99", expense: read.data });
  };

  document.getElementById("delMonth").onclick = async () => {
    if (!budgetId) return log(testOut, "Run seed first.");
    const del = await supabase.from("months").delete().eq("budget_id", budgetId).eq("month_key","2026-01");
    if (del.error) return log(testOut, del.error);
    log(testOut, { deleted: true });
  };

  await refreshAuth();
</script>
</body>
</html>

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SimpleSpend Seed</title>
  <style>
    body { font-family: system-ui; padding: 16px; max-width: 900px; margin: 0 auto; }
    input, button { font-size: 16px; padding: 10px; margin: 6px 0; width: 100%; }
    pre { background: #f4f4f4; padding: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid #ddd; padding: 12px; border-radius: 10px; margin: 12px 0; }
  </style>
</head>
<body>

<h1>Seed + RLS Test</h1>

<script src="./js/config.js"></script>

<div class="card">
  <h2>Auth</h2>
  <div class="row">
    <input id="email" placeholder="email" />
    <input id="password" type="password" placeholder="password" />
  </div>
  <button id="signIn">Sign In</button>
  <button id="signOut">Sign Out</button>
  <pre id="authOut">Not signed in</pre>
</div>

<div class="card">
  <h2>Seed</h2>
  <button id="seed">Run Seed</button>
  <pre id="seedOut"></pre>
</div>

<div class="card">
  <h2>Tests</h2>
  <button id="listBudgets">List Budgets</button>
  <button id="checkExtra">Check extra99</button>
  <button id="catDelete">Delete category â†’ move expense</button>
  <button id="delMonth">Delete month</button>
  <pre id="testOut"></pre>
</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(
    window.SS_CONFIG.SUPABASE_URL,
    window.SS_CONFIG.SUPABASE_ANON_KEY
  );

  const authOut = document.getElementById("authOut");
  const seedOut = document.getElementById("seedOut");
  const testOut = document.getElementById("testOut");

  const log = (el, x) => el.textContent = typeof x === "string" ? x : JSON.stringify(x, null, 2);

  let budgetId = null;

  async function refreshAuth() {
    const { data } = await supabase.auth.getSession();
    log(authOut, data?.session ? data.session.user.email : "Not signed in");
  }

  document.getElementById("signIn").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) return log(authOut, error);

  await refreshAuth();
};


  document.getElementById("signOut").onclick = async () => {
    await supabase.auth.signOut();
    refreshAuth();
  };

  document.getElementById("seed").onclick = async () => {
    seedOut.textContent = "Running...";
    const { data: sess } = await supabase.auth.getSession();
    if (!sess.session) return log(seedOut, "Sign in first");

    const { data: bid, error: rpcErr } = await supabase
      .rpc("create_budget_for_current_user", { budget_name: "My First Budget" });

    if (rpcErr) return log(seedOut, rpcErr);
    budgetId = bid;

    let r;

    r = await supabase.from("months").insert({
      budget_id: budgetId,
      month_key: "2026-01",
      income_cents: 800000
    });
    if (r.error) return log(seedOut, r.error);

    r = await supabase.from("monthly_categories").insert({
      budget_id: budgetId,
      month_key: "2026-01",
      category_key: "groceries",
      name: "Groceries",
      budgeted_cents: 60000,
      sort_order: 10,
      is_extra: false
    });
    if (r.error) return log(seedOut, r.error);

    r = await supabase.from("monthly_expenses").insert({
      budget_id: budgetId,
      month_key: "2026-01",
      category_key: "groceries",
      vendor: "Walmart",
      item: "Food",
      amount_cents: 12345,
      expense_date: "2026-01-05"
    });
    if (r.error) return log(seedOut, r.error);

    log(seedOut, { ok: true, budgetId });
  };

  document.getElementById("listBudgets").onclick = async () => {
    const { data, error } = await supabase.from("budgets").select("id,name");
    log(testOut, error || data);
  };

  document.getElementById("checkExtra").onclick = async () => {
    const { data, error } = await supabase
      .from("monthly_categories")
      .select("category_key,is_extra")
      .eq("budget_id", budgetId)
      .eq("month_key", "2026-01");
    log(testOut, error || data);
  };

  document.getElementById("catDelete").onclick = async () => {
    const key = "tmp_" + Math.random().toString(16).slice(2, 6);

    let r = await supabase.from("monthly_categories").insert({
      budget_id: budgetId,
      month_key: "2026-01",
      category_key: key,
      name: "Temp",
      budgeted_cents: 1000,
      sort_order: 20,
      is_extra: false
    });
    if (r.error) return log(testOut, r.error);

    const ex = await supabase.from("monthly_expenses").insert({
      budget_id: budgetId,
      month_key: "2026-01",
      category_key: key,
      vendor: "Test",
      item: "Item",
      amount_cents: 500,
      expense_date: "2026-01-06"
    }).select("id").single();
    if (ex.error) return log(testOut, ex.error);

    r = await supabase.from("monthly_categories")
      .delete()
      .eq("budget_id", budgetId)
      .eq("month_key", "2026-01")
      .eq("category_key", key);
    if (r.error) return log(testOut, r.error);

    const chk = await supabase.from("monthly_expenses")
      .select("category_key")
      .eq("id", ex.data.id)
      .single();

    log(testOut, chk.error || chk.data);
  };

  document.getElementById("delMonth").onclick = async () => {
    const r = await supabase.from("months")
      .delete()
      .eq("budget_id", budgetId)
      .eq("month_key", "2026-01");
    log(testOut, r.error || { deleted: true });
  };

  refreshAuth();
</script>

</body>
</html>
